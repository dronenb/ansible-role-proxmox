---
# yamllint disable rule:line-length
# tasks file for proxmox
- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"

- name: Remove Proxmox enterprise repo from apt
  loop:
    - /etc/apt/sources.list.d/pve-enterprise.list
    - /etc/apt/sources.list.d/pve-enterprise.list.dpkg-dist
    - /etc/apt/sources.list.d/ceph.list
    - /etc/apt/sources.list.d/pve-enterprise.sources
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent

- name: Variabilize Proxmox no-sub repo
  ansible.builtin.set_fact:
    proxmox_no_sub_repo: pve-install-repo

- name: Ensure Debian archive keyring package is present
  ansible.builtin.apt:
    name: debian-archive-keyring
    state: present
    update_cache: false

- name: Check for existing /etc/apt/sources.list
  ansible.builtin.stat:
    path: /etc/apt/sources.list
  register: sources_list_stat

- name: Backup existing /etc/apt/sources.list
  when: sources_list_stat.stat.exists
  ansible.builtin.copy:
    src: /etc/apt/sources.list
    dest: /etc/apt/sources.list.bak
    remote_src: true
    backup: true
    mode: '0644'

- name: Replace /etc/apt/sources.list with managed notice
  ansible.builtin.copy:
    dest: /etc/apt/sources.list
    content: "# Managed by Ansible. Sources moved to /etc/apt/sources.list.d/*.sources\n"
    backup: true
    mode: '0644'

- name: Add Debian repo (deb822 format)
  ansible.builtin.deb822_repository:
    name: debian
    types: deb
    uris: https://deb.debian.org/debian
    suites: "{{ ansible_facts.distribution_release }} {{ ansible_facts.distribution_release }}-updates"
    components:
      - main
      - non-free-firmware
    signed_by: /usr/share/keyrings/debian-archive-keyring.gpg
    state: present

- name: Add Debian Security repo (deb822 format)
  ansible.builtin.deb822_repository:
    name: debian-security
    types: deb
    uris: https://security.debian.org/debian-security/
    suites: "{{ ansible_facts.distribution_release }}-security"
    components:
      - main
      - non-free-firmware
    signed_by: /usr/share/keyrings/debian-archive-keyring.gpg
    state: present

- name: Remove Proxmox VE Enterprise Repository
  ansible.builtin.deb822_repository:
    name: pve-enterprise
    types: deb
    uris: https://enterprise.proxmox.com/debian/pve
    suites: "{{ ansible_facts.distribution_release }}"
    components:
      - pve-enterprise
    signed_by: /usr/share/keyrings/proxmox-archive-keyring.gpg
    state: absent

- name: Add Proxmox VE no subscription repo
  ansible.builtin.deb822_repository:
    name: proxmox
    types: deb
    uris: http://download.proxmox.com/debian/pve
    suites: "{{ ansible_facts.distribution_release }}"
    components:
      - pve-no-subscription
    signed_by: /usr/share/keyrings/proxmox-archive-keyring.gpg
    state: present

- name: Add Ceph no subscription repo
  ansible.builtin.deb822_repository:
    name: ceph
    types: deb
    uris: http://download.proxmox.com/debian/ceph-squid
    suites: "{{ ansible_facts.distribution_release }}"
    components:
      - no-subscription
    signed_by: /usr/share/keyrings/proxmox-archive-keyring.gpg
    state: present

# This is after the proxmox repo removal/add intentionally
# Since this role includes apt update/upgrade
- name: Include Debian role
  ansible.builtin.include_role:
    name: dronenb.debian

- name: Install useful packages
  ansible.builtin.apt:
    update_cache: true
    pkg:
      - jq
      - libguestfs-tools
      # Required for my custom cloud image download libraries
      - python3-bs4
      - python3-lxml
      - python3-certifi
      - unattended-upgrades

- name: Check if hush login enabled
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.hushlogin"
  register: hushlogin_stat

- name: Enable hush login
  when: not hushlogin_stat.stat.exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.hushlogin"
    state: touch
    mode: '644'

- name: Add proxmoxlib.js path to variable
  ansible.builtin.set_fact:
    proxmoxlib_path: >-
      /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js

- name: Check proxmoxlib.js.bak exists
  ansible.builtin.stat:
    path: "{{ proxmoxlib_path }}.bak"
  register: pmx_js_bak

- name: Make backup from proxmoxlib.js
  when: not pmx_js_bak.stat.exists
  ansible.builtin.copy:
    src: "{{ proxmoxlib_path }}"
    dest: "{{ proxmoxlib_path }}.bak"
    remote_src: true
    mode: '0644'

- name: Remove no valid sub popup
  ansible.builtin.replace:
    path: "{{ proxmoxlib_path }}"
    regexp: >-
      (^\s+)(Ext.Msg.show\(\{\s+title:\s+gettext\('No valid subscription)
    replace: '\1void({ //\2'
    backup: true
  notify: Restart pveproxy

- name: Enable IOMMU (Intel)
  when: >-
    ansible_facts.processor |
      list |
      intersect(['GenuineIntel']) |
      length > 0
  block:
    - name: Check if grub already contains intel_iommu
      ansible.builtin.command:
        argv:
          - grep
          - -q
          - intel_iommu=on
          - /etc/default/grub
      register: grub_iommu_check
      ignore_errors: true
      changed_when: false

    - name: Add intel_iommu to GRUB_CMDLINE_LINUX_DEFAULT
      when: grub_iommu_check.rc != 0
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        regexp: '^(GRUB_CMDLINE_LINUX_DEFAULT=)"(.*)"'
        line: 'GRUB_CMDLINE_LINUX_DEFAULT="\2 intel_iommu=on"'
        backrefs: true
      notify: Update grub

- name: Install microcode on Intel systems
  when: >-
    ansible_facts.processor |
      list |
      intersect(['GenuineIntel']) |
      length > 0
  ansible.builtin.apt:
    name: intel-microcode
    state: present
    update_cache: false

- name: Check existing Proxmox roles
  changed_when: false
  ansible.builtin.command:
    cmd: /usr/sbin/pveum role list --output-format json
  register: existing_proxmox_roles_output

- name: Parse Proxmox roles JSON
  ansible.builtin.set_fact:
    # yamllint disable-line rule:line-length
    existing_proxmox_roles: "{{ existing_proxmox_roles_output.stdout | from_json }}"

- name: Create Proxmox roles
  when: proxmox_roles is defined
  loop: "{{ proxmox_roles }}"
  loop_control:
    label: "{{ item.name }}"
  ansible.builtin.include_tasks: create_proxmox_roles.yml

- name: Check existing Proxmox users
  changed_when: false
  ansible.builtin.command:
    cmd: /usr/sbin/pveum user list --output-format json
  register: existing_proxmox_user_output

- name: Parse Proxmox user JSON
  ansible.builtin.set_fact:
    # yamllint disable-line rule:line-length
    existing_proxmox_users: "{{ existing_proxmox_user_output.stdout | from_json }}"

- name: Create Proxmox users
  when: proxmox_users is defined
  loop: "{{ proxmox_users }}"
  loop_control:
    label: "{{ item.username }}"
  ansible.builtin.include_tasks: create_proxmox_users.yml

- name: Retrieve image URL and checksum for Fedora CoreOS image
  get_fedora_coreos:
  register: fcos_image

- name: Retrieve image URL and checksum for Debian Cloud image
  get_debian_cloud:
  register: debian_cloud_image

- name: Retrieve image URL and checksum for Rocky Cloud image
  get_rocky_cloud:
  register: rocky_cloud_image

- name: Retrieve image URL and checksum for Ubuntu Cloud image
  get_ubuntu_cloud:
  register: ubuntu_cloud_image

- name: Get list of existing Proxmox VM Templates
  get_proxmox_vm_templates:
  register: existing_proxmox_templates

- name: Get list of Proxmox image datastores
  ansible.builtin.command:
    # yamllint disable-line rule:line-length
    cmd: pvesh get /nodes/{{ inventory_hostname }}/storage -content images --output-format json
  register: image_datastores_output
  changed_when: false

- name: Parse Proxmox image datastores output
  ansible.builtin.set_fact:
    image_datastores: "{{ image_datastores_output.stdout | from_json }}"

- name: Create variable for Proxmox datastore if unset
  when: proxmox_template_datastore is undefined
  ansible.builtin.set_fact:
    proxmox_template_datastore: "{{ image_datastores.0.storage }}"

- name: Download and install cloud images to Proxmox
  loop:
    - "{{ debian_cloud_image }}"
    - "{{ rocky_cloud_image }}"
    - "{{ ubuntu_cloud_image }}"
    - "{{ fcos_image }}"
  loop_control:
    loop_var: image
    label: "{{ image.meta.image_name }}"
  vars:
    # yamllint disable-line rule:line-length
    query1: "[?name==`{{ image.meta.template_name }}` && image_checksum==`{{ image.meta.image_checksum }}`]"
  when: not (existing_proxmox_templates.meta | default([]) | json_query(query1))
  ansible.builtin.include_tasks: create_cloud_vm_template.yml

- name: Get available Proxmox LXC templates
  ansible.builtin.command:
    cmd: pveam update
  changed_when: false

- name: List available Debian/Ubuntu/Rocky LXC templates
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -o pipefail
      pveam available --section system |
        awk '{print $2}' |
        grep -E '^ubuntu|debian|rockylinux'
  register: lxc_templates
  changed_when: false

- name: "Download Proxmox LXC templates"
  loop: "{{ lxc_templates.stdout_lines }}"
  loop_control:
    loop_var: template_filename
  ansible.builtin.include_tasks: download_lxc_template.yml
